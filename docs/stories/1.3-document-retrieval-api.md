# Story 1.3: Document Retrieval API Endpoints

## Status
**Ready for Review**

---

## Story

**As a** backend developer,  
**I want** API endpoints to retrieve document lists and individual files,  
**so that** the frontend can display and access documents.

---

## Acceptance Criteria

1. `GET /api/documents` returns array of all documents with fields: id, filename, original_filename, pillar, category, file_type, file_size, upload_date
2. `GET /api/documents/pillar/:pillar` returns filtered array of documents for specified pillar
3. `GET /api/documents/pillar/:pillar/category/:category` returns filtered array for pillar + category combination
4. `GET /api/documents/:id` returns single document metadata or 404 if not found
5. `GET /api/documents/:id/download` serves the actual file with correct Content-Type header and Content-Disposition for inline viewing (PDFs) or download (DOCX, XLSX)
6. `DELETE /api/documents/:id` deletes document record from database, deletes file from filesystem, and returns 204 status
7. All list endpoints return results ordered by upload_date DESC (newest first)
8. All endpoints handle database/filesystem errors with 500 status and descriptive error messages
9. Document counts endpoint: `GET /api/documents/counts` returns object with count per pillar and category

---

## Tasks / Subtasks

- [x] Implement list all documents endpoint (AC: 1, 7)
  - [x] Create GET /api/documents route handler
  - [x] Query all documents from database
  - [x] Order by upload_date DESC
  - [x] Return JSON array

- [x] Implement filter by pillar endpoint (AC: 2, 7)
  - [x] Create GET /api/documents/pillar/:pillar route
  - [x] Validate pillar parameter
  - [x] Query filtered documents
  - [x] Return JSON array

- [x] Implement filter by pillar and category (AC: 3, 7)
  - [x] Create GET /api/documents/pillar/:pillar/category/:category route
  - [x] Validate parameters
  - [x] Query with both filters
  - [x] Return JSON array

- [x] Implement get single document (AC: 4)
  - [x] Create GET /api/documents/:id route
  - [x] Query document by ID
  - [x] Return 404 if not found
  - [x] Return document metadata JSON

- [x] Implement file download/view (AC: 5)
  - [x] Create GET /api/documents/:id/download route
  - [x] Retrieve document metadata from database
  - [x] Read file from filesystem using file_path
  - [x] Set Content-Type header based on file_type
  - [x] Set Content-Disposition: inline for PDFs, attachment for others
  - [x] Stream file to response

- [x] Implement document deletion (AC: 6)
  - [x] Create DELETE /api/documents/:id route
  - [x] Delete database record
  - [x] Delete file from filesystem
  - [x] Return 204 No Content
  - [x] Handle errors if file doesn't exist

- [x] Implement document counts (AC: 9)
  - [x] Create GET /api/documents/counts route
  - [x] Query counts grouped by pillar and category
  - [x] Return nested object structure

- [x] Implement error handling (AC: 8)
  - [x] Handle database errors (500)
  - [x] Handle file not found (404)
  - [x] Handle filesystem errors (500)
  - [x] Log all errors

---

## Dev Notes

### API Endpoints

**GET /api/documents**
- Returns: Array of all documents
- Order: newest first

**GET /api/documents/pillar/:pillar**
- Parameters: pillar (pillar-1|pillar-2|pillar-3|pillar-4|kpis|capa)
- Returns: Filtered array

**GET /api/documents/pillar/:pillar/category/:category**
- Parameters: pillar, category (policies|procedures|forms|evidence)
- Returns: Filtered array

**GET /api/documents/:id**
- Parameters: id (integer)
- Returns: Single document object or 404

**GET /api/documents/:id/download**
- Parameters: id (integer)
- Returns: File stream with appropriate headers

**DELETE /api/documents/:id**
- Parameters: id (integer)
- Returns: 204 No Content

**GET /api/documents/counts**
- Returns: Document counts object

### Document Counts Response Format

```json
{
  "pillar-1": {
    "policies": 5,
    "procedures": 3,
    "forms": 8,
    "evidence": 12,
    "total": 28
  },
  "pillar-2": {
    "policies": 4,
    "procedures": 2,
    "forms": 6,
    "evidence": 10,
    "total": 22
  },
  "kpis": {
    "total": 5
  },
  "capa": {
    "total": 3
  },
  "grandTotal": 58
}
```

### Content-Type Mapping

```typescript
const contentTypes: Record<string, string> = {
  'pdf': 'application/pdf',
  'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'jpg': 'image/jpeg',
  'jpeg': 'image/jpeg',
  'png': 'image/png'
};
```

### File Download Implementation

```typescript
router.get('/:id/download', async (req, res) => {
  const document = await documentRepo.findById(req.params.id);
  
  if (!document) {
    return res.status(404).json({ error: 'Document not found' });
  }
  
  const filePath = path.join(__dirname, '../', document.filePath);
  
  // Set Content-Type
  res.setHeader('Content-Type', document.fileType);
  
  // Set Content-Disposition (inline for PDFs, attachment for others)
  const disposition = document.fileType === 'application/pdf' 
    ? 'inline' 
    : 'attachment';
  res.setHeader('Content-Disposition', `${disposition}; filename="${document.originalFilename}"`);
  
  // Stream file
  const fileStream = fs.createReadStream(filePath);
  fileStream.pipe(res);
});
```

---

## Testing

### Manual Testing with cURL

```bash
# List all documents
curl http://localhost:5000/api/documents

# List by pillar
curl http://localhost:5000/api/documents/pillar/pillar-1

# List by pillar and category
curl http://localhost:5000/api/documents/pillar/pillar-1/category/policies

# Get single document
curl http://localhost:5000/api/documents/1

# Download document
curl http://localhost:5000/api/documents/1/download -o downloaded.pdf

# Get counts
curl http://localhost:5000/api/documents/counts

# Delete document
curl -X DELETE http://localhost:5000/api/documents/1
```

### Testing Standards

- Test all endpoints with valid data
- Test 404 scenarios (non-existent IDs)
- Test invalid pillar/category parameters
- Verify file streaming works for all file types
- Verify deletion removes both database record and file

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (2024-10-22)

### Implementation Summary
Successfully implemented all document retrieval API endpoints with comprehensive error handling and validation.

### Completion Notes
- Added 7 new GET/DELETE endpoints to documents route
- Implemented getCounts() method in documentRepository for aggregated statistics
- All endpoints properly validate parameters and return appropriate HTTP status codes
- File download endpoint correctly streams files with proper Content-Type and Content-Disposition headers
- Delete endpoint removes both database record and filesystem file
- All list endpoints return results ordered by upload_date DESC
- Comprehensive error handling for 400, 404, and 500 scenarios

### File List
**Modified Files:**
- `backend/src/repositories/documentRepository.ts` - Added getCounts() method
- `backend/src/routes/documents.ts` - Added 7 new endpoints (GET /, GET /pillar/:pillar, GET /pillar/:pillar/category/:category, GET /:id, GET /:id/download, DELETE /:id, GET /counts)

**No New Files Created** - All functionality added to existing files

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
| Timestamp | Change | Reason |
|-----------|--------|--------|
| 2025-10-28 17:18 | Implemented all retrieval endpoints | Added list, filter, get single, download, delete, and counts endpoints |
| 2025-10-28 17:18 | Added getCounts() repository method | Aggregates document counts by pillar and category for dashboard |
