# Story 2.10: Display Names for Documents with File Type Icons

## Status
**Ready for Review**

## Story
**As an** HR manager,  
**I want** to optionally rename documents during upload and see file type icons instead of extensions,  
**so that** document lists are cleaner and more professional during audits.

## Acceptance Criteria

### Backend Changes
1. Database schema updated: `documents` table has `display_name TEXT` column (nullable) with index `idx_documents_display_name`
2. Upload endpoint (`POST /api/documents/upload`) accepts optional `displayName` field (multipart form data)
3. Display name validation: Trims whitespace, rejects if empty after trim, max 255 chars, no path separator characters (`/`, `\`, `<`, `>`, `:`, `"`, `|`, `?`, `*`)
4. Display name stored in database as `NULL` if not provided or empty after trim
5. All document list endpoints (`GET /api/documents/*`) return `displayName` field in response
6. Search endpoint (`GET /api/search`) searches both `display_name` and `original_filename` fields
7. Search results prioritize: (1) display_name exact match, (2) display_name partial, (3) original_filename exact, (4) original_filename partial
8. Error handling: Returns 400 with clear message if display name validation fails

### Frontend - Upload Modal
9. Upload modal includes "Display Name (Optional)" TextField below file selection
10. Field has helper text: "Leave empty to use filename without extension"
11. Character counter shows "X / 255" below field
12. Client-side validation: Warns if >255 chars or contains invalid characters before submit
13. Display name field submitted as `displayName` in FormData (omitted if empty)

### Frontend - Display Logic
14. Document list shows computed display name: use `displayName` if present, else `originalFilename` with extension removed
15. File extensions never shown in document name column
16. File type icon displayed next to document name based on file extension:
    - PDF: `PictureAsPdfIcon` with red color (#d32f2f)
    - DOCX/DOC: `DescriptionIcon` with blue color (#1976d2)
    - XLSX/XLS: `TableChartIcon` with green color (#388e3c)
    - JPG/JPEG/PNG: `ImageIcon` with purple color (#7b1fa2)
    - Other: `InsertDriveFileIcon` with default color
17. Document viewer modal header shows computed display name with file type icon
18. Search results display computed display name with file type icon

### Edge Cases
19. Empty display name submitted → Stored as `NULL`, displays original filename without extension
20. Display name with special characters → Rejected with 400 error and clear message
21. Display name 256+ characters → Rejected with 400 error message
22. Existing documents (before feature) → Display original filename without extension (graceful fallback)
23. Duplicate display names allowed → Multiple documents can have same display name (no uniqueness validation)
24. Display name with extension included → Allowed (user's choice), displayed as provided

### Testing Scenarios
25. Upload document with display name "Q4 Safety Report" → Displays "Q4 Safety Report" in list with appropriate icon
26. Upload document without display name → Displays original filename without extension (e.g., "fire_drill_2025.pdf" → "fire_drill_2025")
27. Search by display name → Finds document, displays correctly in results
28. View document with display name → Modal header shows display name + file type icon
29. Upload with 256-char display name → Returns 400 error, upload fails gracefully with snackbar message
30. Upload with display name containing `/` → Returns 400 error, upload fails gracefully

## Tasks / Subtasks

### Backend Implementation
- [x] Database migration
  - [x] Run ALTER TABLE to add `display_name TEXT` column
  - [x] Create index on `display_name` for search performance
  - [x] Verify schema with test query
- [x] Update TypeScript interfaces
  - [x] Add `displayName: string | null` to Document interface
  - [x] Update DocumentUploadRequest interface
  - [x] Update DocumentCreateData interface
- [x] Modify document repository
  - [x] Update `create()` method to accept and store `displayName`
  - [x] Update SQL INSERT to include `display_name` column
  - [x] Update result mapping to include displayName field
- [x] Update upload controller
  - [x] Extract `displayName` from req.body
  - [x] Implement validation function (trim, length, characters)
  - [x] Pass validated displayName to repository
  - [x] Add error handling for validation failures
- [x] Update search controller
  - [x] Modify SQL query to search `display_name` field
  - [x] Update ORDER BY for relevance ranking
  - [x] Test search with display names

### Frontend Implementation
- [x] Create utility functions (`utils/documentDisplay.ts`)
  - [x] `getDisplayName(document: Document): string`
  - [x] `removeFileExtension(filename: string): string`
  - [x] `getFileExtension(filename: string): string`
  - [x] `getFileTypeIcon(extension: string): ReactNode`
- [x] Update TypeScript interfaces
  - [x] Add `displayName: string | null` to Document interface
- [x] Update Upload Modal component
  - [x] Add "Display Name (Optional)" TextField
  - [x] Add helper text and character counter
  - [x] Implement client-side validation
  - [x] Add displayName to FormData on submit
  - [x] Show validation errors in UI
- [x] Update Document List components
  - [x] Replace `originalFilename` with `getDisplayName(document)`
  - [x] Replace text-based file type with `getFileTypeIcon(...)`
  - [x] Update PillarView table
  - [x] Update SearchResults cards
- [x] Update Document Viewer Modal
  - [x] Display computed display name in modal header
  - [x] Show file type icon next to name
- [x] Testing
  - [x] Test upload with display name
  - [x] Test upload without display name
  - [x] Test validation errors
  - [x] Test existing documents display
  - [x] Test search functionality

## Dev Notes

### Database Migration SQL

```sql
-- Add display_name column
ALTER TABLE documents ADD COLUMN display_name TEXT;

-- Create index for search performance
CREATE INDEX IF NOT EXISTS idx_documents_display_name 
ON documents(display_name COLLATE NOCASE);
```

### Validation Function (Backend)

```typescript
function validateDisplayName(displayName: string | null): string | null {
  if (displayName === null || displayName === undefined) {
    return null; // Optional field
  }
  
  const trimmed = displayName.trim();
  
  if (trimmed.length === 0) {
    throw new BadRequestError('Display name cannot be empty or whitespace');
  }
  
  if (trimmed.length > 255) {
    throw new BadRequestError('Display name must be 255 characters or less');
  }
  
  // Check for invalid path characters
  if (/[\/\\<>:"|?*\x00-\x1F]/.test(trimmed)) {
    throw new BadRequestError('Display name contains invalid characters');
  }
  
  return trimmed;
}
```

### Display Logic (Frontend)

```typescript
export function getDisplayName(document: Document): string {
  if (document.displayName) {
    return document.displayName;
  }
  return removeFileExtension(document.originalFilename);
}

export function removeFileExtension(filename: string): string {
  const lastDotIndex = filename.lastIndexOf('.');
  if (lastDotIndex === -1) return filename;
  return filename.substring(0, lastDotIndex);
}

export function getFileExtension(filename: string): string {
  const lastDotIndex = filename.lastIndexOf('.');
  if (lastDotIndex === -1) return '';
  return filename.substring(lastDotIndex + 1).toLowerCase();
}
```

### Priority
Medium - Improves UX and professional appearance, not blocking core functionality

### Estimated Effort
2.5-3 hours (Backend: 45-60 min, Frontend: 60-90 min, Testing: 30 min)

### Dependencies
- Requires Story 1.2 (File Upload API) - ✅ Complete
- Requires Story 1.5 (Upload UI) - ✅ Complete
- Requires Story 1.6 (Pillar View) - ✅ Complete
- Requires Story 2.2 (Search UI) - ✅ Complete

### Architecture Reference
See `/docs/stories/2.10-architecture-notes.md` for complete architectural design by Winston

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from architect's design | James (Dev) with Winston (Architect) |
| Oct 28, 2025 | 2.0 | Implementation completed - All tasks done, manual testing passed | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (primary implementation)

### Debug Log References
None - Implementation completed without issues

### Completion Notes
✅ **Feature successfully implemented and tested**

**Manual Testing Confirmed:**
- Upload with display name: Working (tested with Greek text "αυτο ειναι κατι" - document ID 9)
- Upload without display name: Working (displays filename without extension)
- File type icons: Displaying correctly (PDF red, DOCX blue, etc.)
- Backward compatibility: Existing documents display correctly
- Character counter: Shows X/255 in UI
- Validation: Backend validates length and special characters

**Backend Tests:**
- API endpoint returns displayName in response
- Database stores display_name correctly (verified with sqlite3)
- Validation rejects invalid characters (/, \, etc.)
- NULL stored when display name not provided

**Build Verification:**
- ✅ Backend TypeScript compiles cleanly
- ✅ Frontend builds successfully for production
- ✅ Both dev servers running without errors

**Database Migration:**
- Column `display_name TEXT` added to documents table
- Index `idx_documents_display_name` created for search performance
- No data migration needed (existing documents gracefully fallback to filename)

### File List
**Files Modified:**
- `backend/src/types/document.ts` - Added displayName field to Document interface
- `backend/src/repositories/documentRepository.ts` - Updated create(), findAll(), search() to include displayName
- `backend/src/routes/documents.ts` - Added displayName validation and handling in upload endpoint
- `frontend/src/types/document.ts` - Added displayName field to Document interface
- `frontend/src/utils/documentDisplay.ts` - **NEW FILE** - Display utility functions (getDisplayName, getFileTypeIcon, etc.)
- `frontend/src/components/documents/UploadModal.tsx` - Added display name TextField with validation
- `frontend/src/pages/PillarView.tsx` - Updated to show file type icons and display names
- `frontend/src/pages/SearchResults.tsx` - Updated to show file type icons and display names
- `frontend/src/services/documentService.ts` - Updated uploadDocument to accept displayName parameter

**Database Changes:**
- `data/smeta.db` - Added `display_name TEXT` column to documents table
- Created index `idx_documents_display_name ON documents(display_name COLLATE NOCASE)`

**No New Database Tables** - Only column addition to existing `documents` table

---
