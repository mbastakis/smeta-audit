# Story 2.3: CAPA Management Backend API

## Status
**Ready for Review**

## Story
**As a** backend developer,  
**I want** CRUD API endpoints for CAPA records,  
**so that** the frontend can manage corrective and preventive actions.

## Acceptance Criteria
1. `GET /api/capas` returns array of all CAPA records with all fields from database schema
2. `GET /api/capas/:id` returns single CAPA record or 404 if not found
3. `GET /api/capas/status/:status` returns filtered CAPAs by status (open, in-progress, closed)
4. `POST /api/capas` creates new CAPA with required fields: capa_id (unique), description, status; optional: pillar, severity, dates, root_cause, actions
5. `PUT /api/capas/:id` updates existing CAPA (all fields editable except id and date_opened)
6. `DELETE /api/capas/:id` deletes CAPA and returns 204 status
7. Validation: capa_id must be unique (return 409 conflict if duplicate), status must be valid enum value
8. Auto-set date_opened to current datetime on POST if not provided
9. Auto-set date_closed to current datetime on PUT when status changed to 'closed'
10. All endpoints return proper error messages for validation failures (400) and server errors (500)

## Tasks / Subtasks
- [x] Create CAPA routes and controller
- [x] Implement GET all CAPAs
- [x] Implement GET by ID and status
- [x] Implement POST create with validation
- [x] Implement PUT update
- [x] Implement DELETE
- [x] Add unique constraint validation
- [x] Add auto-date logic for date_closed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (2024-10-22)

### Implementation Summary
Successfully implemented complete CAPA management API with full CRUD operations, validation, and auto-date logic.

### Completion Notes
- Created CAPA routes at /api/capas with 6 endpoints
- Implemented CAPARepository with all CRUD methods
- GET /api/capas returns all CAPAs ordered by date_opened DESC
- GET /api/capas/:id returns single CAPA or 404
- GET /api/capas/status/:status filters by status (open, in-progress, closed)
- POST /api/capas creates with validation: capa_id (unique), description (required), status enum
- PUT /api/capas/:id updates all fields except id and date_opened
- DELETE /api/capas/:id deletes and returns 204
- Unique capa_id constraint enforced with 409 Conflict response
- Auto-set date_opened to current datetime if not provided on POST
- Auto-set date_closed to current datetime when status changes to 'closed'
- Comprehensive validation: required fields, enum values (status, pillar, severity)
- Proper error messages for all failure scenarios (400, 404, 409, 500)

### File List
**New Files Created:**
- `backend/src/types/capa.ts` - TypeScript interfaces for CAPA model
- `backend/src/repositories/capaRepository.ts` - CAPA repository with CRUD methods
- `backend/src/routes/capas.ts` - CAPA API route handlers

**Modified Files:**
- `backend/src/app.ts` - Registered CAPA routes

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
| Timestamp | Change | Reason |
|-----------|--------|--------|
| 2025-10-28 19:47 | Implemented CAPA repository and routes | Created full CRUD API with validation |
| 2025-10-28 19:47 | Added auto-date logic | Automatic date_opened and date_closed management |
| 2025-10-28 19:47 | Added unique constraint validation | Prevent duplicate capa_id with 409 response |
