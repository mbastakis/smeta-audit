# Story 3.1: KPIs Dashboard Implementation

## Status
**Ready for Development**

---

## Story

**As an** HR/Compliance Manager,  
**I want** a dedicated KPIs Dashboard section to organize and view statistics, research reports, KPI metrics, organization charts, and business plans,  
**so that** I can present comprehensive business intelligence and strategic planning documents to auditors alongside compliance documentation.

---

## Acceptance Criteria

1. KPIs Dashboard page accessible from dashboard card at route `/kpis` with breadcrumb navigation "Home > KPIs Dashboard"
2. Dashboard displays 5 category cards in grid layout: Statistics, Research, KPIs, Organization Chart, Business Plan
3. Each category page shows list of uploaded items with: thumbnail/icon, title, upload date, file type indicator
4. Upload functionality supports two types: **Single files** (PDF, XLSX, DOCX, images) and **HTML packages** (ZIP containing index.html + assets)
5. Single file uploads work like existing document upload (drag-drop, metadata, storage)
6. HTML package uploads extract ZIP to dedicated folder structure: `backend/uploads/kpis/{category}/{item-id}/`
7. Viewing single files uses existing DocumentViewerModal for PDFs, download for XLSX/DOCX
8. Viewing HTML packages opens in new window/tab serving the extracted HTML with full assets (CSS, JS, images)
9. Backend serves HTML packages securely via endpoint `GET /api/kpis/:id/view` with proper MIME types
10. Delete functionality removes item metadata from database and all associated files/folders
11. Empty state shows "No items uploaded yet" with "Upload" button for each category
12. All KPI items stored in new database table with fields: id, title, category, file_type, upload_date, file_path/folder_path
13. HTML packages render correctly with all CSS/JS/assets loaded (relative paths preserved)
14. Security: HTML packages served from isolated directory with appropriate headers (X-Frame-Options, CSP if needed)
15. Responsive layout: category grid adapts to screen size, item cards display consistently

---

## Technical Architecture

### Recommended Approach: Hybrid Storage Model

**Rationale:** Support both simple file uploads (like existing documents) and complex HTML projects (with folder structures) using a unified interface.

#### Storage Strategy

```
backend/uploads/kpis/
├── statistics/
│   ├── single-file-123/               # Single file (PDF, XLSX, etc.)
│   │   └── dashboard.pdf
│   ├── html-package-456/              # HTML package (extracted ZIP)
│   │   ├── index.html
│   │   ├── style.css
│   │   ├── script.js
│   │   └── assets/
│   │       └── logo.png
├── research/
├── kpis/
├── org-chart/
└── business-plan/
```

#### Database Schema Addition

```sql
-- New table for KPI items
CREATE TABLE IF NOT EXISTS kpi_items (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  category TEXT NOT NULL CHECK(category IN ('statistics', 'research', 'kpis', 'org-chart', 'business-plan')),
  file_type TEXT NOT NULL CHECK(file_type IN ('pdf', 'xlsx', 'docx', 'jpg', 'png', 'html-package')),
  upload_date TEXT NOT NULL DEFAULT (datetime('now')),
  folder_path TEXT NOT NULL UNIQUE,  -- Path to folder (single file or HTML package)
  has_index_html BOOLEAN NOT NULL DEFAULT 0,  -- True for HTML packages
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_kpi_items_category ON kpi_items(category);
CREATE INDEX IF NOT EXISTS idx_kpi_items_type ON kpi_items(file_type);
```

#### API Endpoints

**KPI Items CRUD:**
- `GET /api/kpis` - List all KPI items
- `GET /api/kpis/category/:category` - List items by category
- `POST /api/kpis/upload` - Upload single file or HTML package (multipart/form-data)
- `DELETE /api/kpis/:id` - Delete KPI item
- `GET /api/kpis/:id/view` - Serve HTML package or redirect to file
- `GET /api/kpis/:id/download` - Download single file

**Upload Endpoint Details:**

```typescript
// POST /api/kpis/upload
// Content-Type: multipart/form-data
{
  file: File,                    // ZIP for HTML package, or PDF/XLSX/etc.
  title: string,                 // Display name
  category: 'statistics' | 'research' | 'kpis' | 'org-chart' | 'business-plan',
  file_type: 'html-package' | 'pdf' | 'xlsx' | 'docx' | 'jpg' | 'png'
}

// Logic:
// 1. If file_type === 'html-package':
//    - Validate ZIP contains index.html
//    - Extract to backend/uploads/kpis/{category}/{id}/
//    - Store folder_path, set has_index_html = true
// 2. Else:
//    - Save single file to backend/uploads/kpis/{category}/{id}/{filename}
//    - Store folder_path, set has_index_html = false
```

#### Serving HTML Packages

**Option 1: Static Serve with Express (RECOMMENDED)**

```typescript
// Backend route
app.get('/api/kpis/:id/view', async (req, res) => {
  const item = await kpiRepository.getById(req.params.id);
  
  if (!item.has_index_html) {
    return res.redirect(`/api/kpis/${item.id}/download`);
  }
  
  // Serve index.html from extracted folder
  const indexPath = path.join(item.folder_path, 'index.html');
  res.sendFile(indexPath, {
    headers: {
      'X-Frame-Options': 'SAMEORIGIN',
      'Content-Security-Policy': "default-src 'self' 'unsafe-inline' 'unsafe-eval'"
    }
  });
});

// Serve assets (CSS, JS, images)
app.use('/api/kpis/:id/assets', express.static(/* folder_path */));
```

**Frontend Implementation:**

```typescript
// Open HTML package in new window
const handleViewHtmlPackage = (item: KPIItem) => {
  window.open(`/api/kpis/${item.id}/view`, '_blank');
};

// For single files, use existing DocumentViewerModal
const handleViewSingleFile = (item: KPIItem) => {
  setViewerDocument(item);
  setViewerOpen(true);
};
```

---

## Frontend Component Structure

```
frontend/src/
├── pages/
│   ├── KPIDashboard.tsx              # Main KPI dashboard with 5 category cards
│   ├── KPICategoryView.tsx           # Category page showing items list
├── components/
│   ├── kpi/
│   │   ├── KPIItemCard.tsx           # Item display card with thumbnail
│   │   ├── KPIUploadModal.tsx        # Upload modal (single file or ZIP)
│   │   ├── KPIItemList.tsx           # List view of items
│   │   └── KPIViewModal.tsx          # View single file (reuse DocumentViewerModal)
├── services/
│   └── kpiService.ts                 # API calls for KPI items
├── types/
│   └── kpi.ts                        # KPIItem interface
```

**TypeScript Interfaces:**

```typescript
export interface KPIItem {
  id: number;
  title: string;
  category: 'statistics' | 'research' | 'kpis' | 'org-chart' | 'business-plan';
  fileType: 'html-package' | 'pdf' | 'xlsx' | 'docx' | 'jpg' | 'png';
  uploadDate: string;
  folderPath: string;
  hasIndexHtml: boolean;
}

export interface KPIUploadRequest {
  file: File;
  title: string;
  category: KPIItem['category'];
  fileType: KPIItem['fileType'];
}
```

---

## Security Considerations

### HTML Package Security

**Risks:**
- User-uploaded HTML could contain malicious scripts
- XSS vulnerabilities if HTML executes arbitrary code
- CSS injection attacks

**Mitigations:**

1. **Isolation:** Serve HTML packages from dedicated subdomain or path (`/kpi-content/`) separate from main app
2. **Content Security Policy:** Apply strict CSP headers to limit script sources
3. **Same-Origin:** Use `X-Frame-Options: SAMEORIGIN` to prevent embedding in external sites
4. **Validation:** Check ZIP contains only allowed file types (html, css, js, jpg, png, svg)
5. **Sanitization (Optional):** For paranoid security, run HTML through sanitizer (DOMPurify) - **NOT RECOMMENDED for overnight timeline**

**Acceptable Risk for MVP:**
- This is a **local, single-user, trusted environment** application
- User is uploading their own HTML reports (not untrusted external content)
- Offline operation means no external script loading
- **Recommendation:** Implement isolation + CSP headers, skip sanitization for MVP

### File Upload Validation

```typescript
// Allowed file types
const ALLOWED_SINGLE_FILES = ['pdf', 'xlsx', 'docx', 'jpg', 'png'];
const ALLOWED_ZIP_CONTENTS = ['html', 'css', 'js', 'jpg', 'png', 'svg', 'json'];

// Validation logic
if (fileType === 'html-package') {
  // Validate ZIP structure
  const zip = await unzip(file);
  if (!zip.includes('index.html')) {
    throw new Error('HTML package must contain index.html');
  }
  // Check all files have allowed extensions
  const invalidFiles = zip.filter(f => !ALLOWED_ZIP_CONTENTS.includes(getExtension(f)));
  if (invalidFiles.length > 0) {
    throw new Error('ZIP contains invalid file types');
  }
}
```

---

## Alternative Approaches (Considered and Rejected)

### Option A: iframe Embedding
**Approach:** Embed HTML packages in iframe within platform  
**Pros:** Keeps user in platform, easier back navigation  
**Cons:** Complex iframe communication, responsive design issues, security risks  
**Verdict:** ❌ Rejected - New window simpler and more reliable

### Option B: Convert HTML to PDF
**Approach:** Convert HTML packages to PDF on upload using headless browser  
**Pros:** Unified file viewing experience, no security risks  
**Cons:** Loses interactivity (charts, filters), requires Puppeteer/Playwright (~200MB dependency), slow conversion  
**Verdict:** ❌ Rejected - Overkill, breaks interactive reports

### Option C: Server-Side Render and Proxy
**Approach:** Backend renders HTML and proxies all asset requests  
**Pros:** Full control over content, security  
**Cons:** Complex proxy logic, breaks relative paths, performance overhead  
**Verdict:** ❌ Rejected - Unnecessary complexity

### Option D: Upload to Database as BLOB
**Approach:** Store HTML content in SQLite as TEXT/BLOB fields  
**Pros:** Self-contained in database  
**Cons:** Complex asset handling, large database size, poor performance  
**Verdict:** ❌ Rejected - Filesystem better for file storage

---

## Implementation Tasks

### Backend Tasks (60 min)

1. **Database Migration** (10 min)
   - Create `kpi_items` table with schema above
   - Add indexes for category and file_type

2. **KPI Repository** (15 min)
   - Create `kpiRepository.ts` with CRUD methods
   - Implement `getAll()`, `getByCategory()`, `create()`, `delete()`

3. **KPI Routes** (20 min)
   - `POST /api/kpis/upload` - Handle single file and ZIP extraction
   - `GET /api/kpis/category/:category` - List items by category
   - `DELETE /api/kpis/:id` - Delete item and files/folders
   - `GET /api/kpis/:id/view` - Serve HTML package or redirect
   - `GET /api/kpis/:id/download` - Download single file

4. **File Upload Handler** (15 min)
   - Add ZIP extraction using `unzipper` npm package
   - Validate ZIP structure (must contain index.html)
   - Create folder structure `kpis/{category}/{id}/`
   - Copy single files or extract ZIP contents

**Dependencies:**
```json
{
  "unzipper": "^0.10.14"  // ZIP extraction
}
```

### Frontend Tasks (60 min)

1. **KPI Service Layer** (10 min)
   - Create `kpiService.ts` with API methods
   - Implement upload, list, delete, view methods

2. **KPI Dashboard Page** (15 min)
   - Create `KPIDashboard.tsx` with 5 category cards
   - Grid layout, icons, navigation to category pages
   - Route: `/kpis`

3. **KPI Category View** (20 min)
   - Create `KPICategoryView.tsx` showing items list
   - Display items as cards with title, date, type indicator
   - Upload button, delete button, view button
   - Route: `/kpis/:category`

4. **KPI Upload Modal** (15 min)
   - Create `KPIUploadModal.tsx` extending existing UploadModal pattern
   - Support single file or ZIP selection
   - Show file type selector (PDF, XLSX, HTML Package, etc.)
   - Title input field for display name

**Integration with existing code:**
- Reuse `UploadModal` structure and styling
- Reuse `DocumentViewerModal` for single file viewing
- Add routes to `App.tsx`: `/kpis` and `/kpis/:category`
- Update Dashboard card click handler to navigate to `/kpis`

---

## Testing Checklist

### Manual Testing (20 min)

- [ ] Navigate to KPIs Dashboard from home page
- [ ] Verify 5 category cards display correctly
- [ ] Upload PDF to Statistics category → displays in list
- [ ] Upload XLSX to KPIs category → downloads when clicked
- [ ] Upload ZIP with HTML package to Research category
  - [ ] Verify ZIP extracts correctly
  - [ ] Click view → opens in new window
  - [ ] Verify CSS loads correctly
  - [ ] Verify JS executes correctly
  - [ ] Verify images/assets display correctly
- [ ] Upload another HTML package to different category
- [ ] Delete item → confirms and removes from list and filesystem
- [ ] Test empty state → "No items uploaded yet" message
- [ ] Test navigation: Dashboard → KPIs → Category → Back
- [ ] Test with actual resources from `resources/` folder:
  - [ ] Upload `Cretamel_Culture_Insights_2025_PREVIEW/` as ZIP
  - [ ] Upload `CAPA_Plan_2025.xlsx`
  - [ ] Verify both work correctly

---

## Estimated Implementation Time

**Total: 2-3 hours**

- Backend (Database + API + File Handling): 60 minutes
- Frontend (Pages + Components + Integration): 60 minutes  
- Testing and Bug Fixes: 30-60 minutes

**Priority:** Medium (enhances platform but not critical for basic audit compliance)

**Dependencies:** Story 2.8 (Footer) recommended to complete first

---

## Notes for Developer

### Quick Start

1. Install `unzipper` package: `npm install unzipper --save` in backend
2. Create database table using schema above
3. Implement backend routes (start with upload, then view)
4. Create frontend pages (KPIDashboard, KPICategoryView)
5. Test with actual ZIP from resources folder

### ZIP Upload from User Perspective

To upload an HTML package:
1. Compress entire folder (including index.html, CSS, JS, assets) to ZIP
2. Open KPIs Dashboard → Select category (e.g., "Statistics")
3. Click "Upload" → Select "HTML Package" type
4. Enter title (e.g., "Culture Insights 2025")
5. Select ZIP file → Upload
6. Item appears in list with "HTML" badge
7. Click "View" → Opens in new tab with full interactive report

### HTML Package Requirements

Valid HTML package structure:
```
package.zip
├── index.html          (REQUIRED - entry point)
├── style.css           (optional)
├── script.js           (optional)
└── assets/             (optional)
    ├── logo.png
    └── chart-data.json
```

**Note:** All paths in HTML must be relative (e.g., `<link href="style.css">`, `<img src="assets/logo.png">`)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created for KPIs Dashboard | Winston (Architect) |
