# Story 1.2: File Upload Backend API

## Status
**Ready for Review**

---

## Story

**As a** backend developer,  
**I want** an API endpoint that accepts file uploads and stores them with metadata,  
**so that** the frontend can upload documents to the system.

---

## Acceptance Criteria

1. `POST /api/documents/upload` endpoint accepts multipart/form-data with fields: `file`, `pillar`, `category`, `original_filename`
2. Endpoint validates required fields (file, pillar) and returns 400 error with message if missing
3. Endpoint validates file type (PDF, DOCX, XLSX, JPG, PNG) and rejects unsupported types with 415 error
4. Endpoint validates file size ≤50MB and rejects larger files with 413 error
5. File saved to `uploads/{pillar}/{category}/` with unique filename (timestamp + random + original extension)
6. Document metadata inserted into `documents` table: filename, original_filename, pillar, category, file_type, file_size, upload_date, file_path
7. Endpoint returns 201 status with JSON response: `{ id, filename, pillar, category, upload_date }`
8. Upload folders automatically created if they don't exist (recursive mkdir)
9. Error handling: Returns 500 with message if file write or database insert fails

---

## Tasks / Subtasks

- [x] Create upload route handler (AC: 1)
  - [x] Create backend/src/routes/documents.ts
  - [x] Configure multer middleware for multipart/form-data
  - [x] Set up multer disk storage with destination function
  - [x] Register route in Express app

- [x] Implement file validation (AC: 2, 3, 4)
  - [x] Validate required fields: file and pillar
  - [x] Create file type validator (PDF, DOCX, XLSX, JPG, PNG)
  - [x] Implement 50MB file size limit in multer config
  - [x] Return appropriate HTTP status codes (400, 415, 413)

- [x] Implement file storage (AC: 5, 8)
  - [x] Create uploads/ directory structure generator
  - [x] Generate unique filename: timestamp-random-extension
  - [x] Implement recursive directory creation (fs.mkdirSync recursive)
  - [x] Save file to uploads/{pillar}/{category}/ path

- [x] Implement database insertion (AC: 6, 7)
  - [x] Create document repository method: insertDocument()
  - [x] Insert metadata into documents table
  - [x] Return inserted document with generated ID
  - [x] Return 201 Created status with JSON response

- [x] Implement error handling (AC: 9)
  - [x] Wrap file operations in try/catch
  - [x] Wrap database operations in try/catch
  - [x] Clean up partially uploaded files on error
  - [x] Return 500 with descriptive error message
  - [x] Log errors to console for debugging

- [x] Test upload endpoint
  - [x] Test with valid PDF file
  - [x] Test with missing required fields
  - [x] Test with invalid file type
  - [x] Test with file >50MB
  - [x] Verify file saved to correct directory
  - [x] Verify database record created

---

## Dev Notes

### API Endpoint Specification

**POST /api/documents/upload**

**Request (multipart/form-data):**
- `file` (File, required) - The document file
- `pillar` (String, required) - One of: pillar-1, pillar-2, pillar-3, pillar-4, kpis, capa
- `category` (String, optional) - One of: policies, procedures, forms, evidence (null for kpis/capa)

**Response (201 Created):**
```json
{
  "id": 1,
  "filename": "1698765432000-abc123.pdf",
  "originalFilename": "Fire Safety Policy.pdf",
  "pillar": "pillar-2",
  "category": "policies",
  "fileType": "application/pdf",
  "fileSize": 1234567,
  "uploadDate": "2025-10-28T10:30:00Z",
  "filePath": "uploads/pillar-2/policies/1698765432000-abc123.pdf"
}
```

**Error Responses:**
- `400 Bad Request` - Missing required fields
- `413 Payload Too Large` - File exceeds 50MB
- `415 Unsupported Media Type` - Invalid file type
- `500 Internal Server Error` - File write or database error

### Multer Configuration

```typescript
import multer from 'multer';
import path from 'path';
import fs from 'fs';

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const { pillar, category } = req.body;
    const uploadPath = path.join(__dirname, '../uploads', pillar, category || '');
    
    // Create directory if it doesn't exist
    fs.mkdirSync(uploadPath, { recursive: true });
    
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    const timestamp = Date.now();
    const randomStr = Math.random().toString(36).substring(2, 8);
    const ext = path.extname(file.originalname);
    cb(null, `${timestamp}-${randomStr}${ext}`);
  }
});

const fileFilter = (req: any, file: any, cb: any) => {
  const allowedTypes = [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'image/jpeg',
    'image/png'
  ];
  
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Unsupported file type'), false);
  }
};

export const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: 50 * 1024 * 1024 // 50MB
  }
});
```

### File Storage Structure

```
backend/uploads/
├── pillar-1/
│   ├── policies/
│   ├── procedures/
│   ├── forms/
│   └── evidence/
├── pillar-2/
│   ├── policies/
│   ├── procedures/
│   ├── forms/
│   └── evidence/
├── pillar-3/
├── pillar-4/
├── kpis/
└── capa/
```

### Database Repository Pattern

```typescript
interface DocumentInsert {
  filename: string;
  originalFilename: string;
  pillar: string;
  category: string | null;
  fileType: string;
  fileSize: number;
  filePath: string;
}

export class DocumentRepository {
  insertDocument(doc: DocumentInsert): Document {
    const stmt = db.prepare(`
      INSERT INTO documents (filename, original_filename, pillar, category, 
                            file_type, file_size, file_path)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);
    
    const result = stmt.run(
      doc.filename,
      doc.originalFilename,
      doc.pillar,
      doc.category,
      doc.fileType,
      doc.fileSize,
      doc.filePath
    );
    
    return this.findById(result.lastInsertRowid as number);
  }
}
```

### Supported File Types

| Extension  | MIME Type                                                               | Category           |
|------------|-------------------------------------------------------------------------|--------------------|
| .pdf       | application/pdf                                                         | Documents          |
| .docx      | application/vnd.openxmlformats-officedocument.wordprocessingml.document | Word Documents     |
| .xlsx      | application/vnd.openxmlformats-officedocument.spreadsheetml.sheet       | Excel Spreadsheets |
| .jpg/.jpeg | image/jpeg                                                              | Images             |
| .png       | image/png                                                               | Images             |

---

## Testing

### Manual Testing with cURL

```bash
# Test valid upload
curl -X POST http://localhost:5000/api/documents/upload \
  -F "file=@test-document.pdf" \
  -F "pillar=pillar-1" \
  -F "category=policies"

# Test missing file
curl -X POST http://localhost:5000/api/documents/upload \
  -F "pillar=pillar-1"

# Test invalid file type
curl -X POST http://localhost:5000/api/documents/upload \
  -F "file=@test.txt" \
  -F "pillar=pillar-1"
```

### Testing Standards

- **Manual API testing** - Use Postman or cURL
- **File validation** - Test all supported file types
- **Error cases** - Test all validation failures
- **Database verification** - Check records inserted correctly
- **File system verification** - Check files saved to correct paths

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (2024-10-22)

### Implementation Summary
Successfully implemented file upload API endpoint with all acceptance criteria met.

### Completion Notes
- Created multer middleware for file upload handling with temp directory approach
- Implemented document repository pattern for database operations
- Added comprehensive validation for file type, size, and required fields
- Files correctly moved to `uploads/{pillar}/{category}/` structure after validation
- All error handling in place with appropriate HTTP status codes (400, 413, 415, 500)
- Tested successfully with PDF uploads, validation failures, and file size limits

### File List
**New Files Created:**
- `backend/src/middleware/upload.ts` - Multer configuration for file uploads
- `backend/src/types/document.ts` - TypeScript interfaces for Document entity
- `backend/src/repositories/documentRepository.ts` - Database repository pattern
- `backend/src/routes/documents.ts` - Document upload API route handler

**Modified Files:**
- `backend/src/app.ts` - Registered documents route

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
| Timestamp | Change | Reason |
|-----------|--------|--------|
| 2025-10-28 17:07 | Initial implementation | Created all required files and routes |
| 2025-10-28 17:11 | Fixed file path handling | Multer can't reliably access req.body in destination callback, used temp directory with post-upload move |

---

## QA Results

*(To be populated after QA review)*
