# Story 3.3: Electron Worktree Audit and Cleanup

## Status
Approved

## Story

**As a** project maintainer,
**I want** to audit the electron-app worktree for uncommitted changes, transfer any valuable configurations or data to the main repository, and clean up the worktree,
**so that** we maintain a single source of truth, avoid losing important work, and reduce repository complexity.

## Context

The electron-app branch exists as a git worktree at `/Users/mbastakis/dev/personal/marvie-smeta-electron`. According to `MERGE_COMPLETE.md`, the core backend unification has already been completed, merging Electron compatibility into the master branch. However, before removing the worktree, we need to ensure:

1. No uncommitted changes exist that should be preserved
2. Any worktree-specific configurations, scripts, or data are transferred
3. The worktree can be safely removed without losing valuable work

### Existing System Integration

- **Git Worktree:** Located at `/Users/mbastakis/dev/personal/marvie-smeta-electron`
- **Branch:** `electron-app` (same commit as master: 7e6f51f)
- **Main Repository:** `/Users/mbastakis/dev/personal/marvie-smeta`
- **Technology:** Git worktrees, bash scripts, Electron build configurations

### Current Electron Implementation Status

Based on project documentation:
- ✅ Backend unified with environment detection (app.ts)
- ✅ Conditional CORS enabled
- ✅ Static file serving configured
- ✅ PDF.js worker fixes applied
- ✅ KPI routes preserved in merge
- ⏳ Worktree cleanup pending

## Acceptance Criteria

### 1. Audit Phase
1. All uncommitted changes in the electron worktree are identified and documented
2. Git status differences between master and electron-app branches are catalogued
3. Worktree-specific files and configurations are inventoried (build configs, scripts, environment files, data directories)
4. Any test data or uploaded files unique to the worktree are identified

### 2. Transfer Phase
5. Valuable uncommitted changes are either committed to the electron-app branch or directly to master (as appropriate)
6. Worktree-specific configurations that should be in main repo are copied over (including package.json electron configurations)
7. Any unique scripts or tools from the worktree are transferred to appropriate locations in main repo
8. Data directories are backed up or transferred if they contain valuable test/reference data
9. A transfer summary document is created at `docs/ELECTRON_WORKTREE_TRANSFER_SUMMARY.md` listing what was transferred and where

### 3. Cleanup Phase
10. The electron-app worktree is safely removed using `git worktree remove`
11. Decision is made and executed on whether to keep or delete the electron-app branch
12. Main repository is verified to contain all necessary Electron functionality
13. Documentation is updated to reflect the single-repository approach
14. All Electron build and launch scripts in main repo are verified to work

### 4. Verification
15. Electron app can be built and launched from main repository
16. Web development mode still works correctly
17. No functionality or configuration has been lost in the cleanup
18. Git repository state is clean and simplified

## Tasks / Subtasks

- [ ] **Task 1: Audit Electron Worktree** (AC: 1, 2, 3, 4)
  - [ ] Navigate to worktree and run `git status` to check for uncommitted changes
  - [ ] Run `git diff master..electron-app` to see branch differences
  - [ ] Inventory all files in worktree root and electron/ directory (if exists)
  - [ ] Check package.json for electron field, build configuration, and electron-specific scripts
  - [ ] Check for unique build scripts (*.sh files) not in main repo
  - [ ] Check data/ directory for unique content compared to main repo
  - [ ] Check backend/uploads/ for test documents not in main repo
  - [ ] Check for environment files (.env, *.env) specific to Electron
  - [ ] Document findings in a structured format with transfer recommendations

- [ ] **Task 2: Transfer Valuable Content** (AC: 5, 6, 7, 8, 9)
  - [ ] Review audit findings and categorize what needs transfer
  - [ ] For uncommitted code changes: create commits on electron-app or cherry-pick to master
  - [ ] Transfer package.json electron configurations (main, scripts.electron, scripts.dist*, build section)
  - [ ] If electron/ directory exists in worktree but not main: copy entire electron/ directory to main repo
  - [ ] For build scripts: verify all electron-related .sh files exist in main repo, copy missing ones
  - [ ] For environment files: document them but evaluate if transfer needed (likely not)
  - [ ] For data directories: create backup in main repo under data-archive/ if valuable test data exists
  - [ ] Create transfer summary document at docs/ELECTRON_WORKTREE_TRANSFER_SUMMARY.md
  - [ ] Update main repo README or docs with any new scripts/tools

- [ ] **Task 3: Clean Up Worktree** (AC: 10, 11, 12, 13)
  - [ ] Verify all valuable content has been transferred
  - [ ] From main repo, run `git worktree list` to confirm worktree location
  - [ ] Remove worktree: `git worktree remove ../marvie-smeta-electron`
  - [ ] Decide on branch retention (recommend: keep electron-app branch as historical reference)
  - [ ] If deleting branch: `git branch -d electron-app` (or -D if needed)
  - [ ] Update MERGE_COMPLETE.md or similar docs to reflect completed cleanup
  - [ ] Remove or update references to worktree in documentation

- [ ] **Task 4: Verification Testing** (AC: 14, 15, 16, 17, 18)
  - [ ] Test Electron build: `bash rebuild-electron.sh`
  - [ ] Test Electron launch: `bash kill-and-launch.sh`
  - [ ] Verify app launches and all features work
  - [ ] Test web dev mode: backend + frontend dev servers
  - [ ] Verify no CORS errors in web mode
  - [ ] Run `git status` and confirm clean state
  - [ ] Run `git worktree list` and confirm no dangling worktrees
  - [ ] Document test results

## Dev Notes

### Relevant Architecture Context

**Git Worktree Background:**
- Git worktrees allow checking out multiple branches simultaneously in different directories
- The electron-app worktree was created to develop Electron support without disrupting main development
- Both worktrees share the same git history but have separate working directories

**Current Repository Structure:**
```
/Users/mbastakis/dev/personal/marvie-smeta/          # Main repo (master branch)
/Users/mbastakis/dev/personal/marvie-smeta-electron/ # Worktree (electron-app branch)
```

**Key Files to Check in Worktree:**
- `electron/` directory (main.js, preload.js, icons/) - **May not exist in main repo yet**
- Root-level build scripts (*.sh files) - Compare with main repo
- `package.json` (Electron-specific configurations) - **Critical to transfer**
- `.electron-temp/` directory contents - Reference material, likely not for transfer
- `backend/src/app.ts` (should be unified already) - Verify no uncommitted changes
- `data/` and `backend/uploads/` directories - Check for unique test data

**Current Main Repo State:**
- ✅ Has Electron build scripts: `rebuild-electron.sh`, `kill-and-launch.sh`, `build-all-platforms.sh`, etc.
- ❓ `electron/` directory: **NOT present in main repo** (needs verification in worktree)
- ❓ `package.json` electron config: **NOT present in main repo** (needs transfer from worktree)
- ✅ Backend unified with environment detection (app.ts)

**Integration Points:**
- Main repo has unified backend (app.ts) with Electron support
- Build scripts exist in main repo for launching Electron
- **Missing**: electron/ directory and package.json configuration (likely in worktree)

### Git Commands Reference

**Audit Commands:**
```bash
cd /Users/mbastakis/dev/personal/marvie-smeta-electron
git status
git diff master
git log master..electron-app
git diff --stat master..electron-app
```

**Cleanup Commands:**
```bash
cd /Users/mbastakis/dev/personal/marvie-smeta
git worktree list
git worktree remove ../marvie-smeta-electron
git branch -d electron-app  # Optional: delete branch
```

### File Transfer Map

**Transfer destinations for worktree files:**

| Source (Worktree) | Destination (Main Repo) | Action |
|-------------------|-------------------------|--------|
| `electron/` directory | `electron/` | Copy if not exists in main |
| `package.json` (electron fields) | `package.json` | Merge electron configurations |
| `*.sh` scripts | `./` (root) | Copy only if missing in main |
| `.env` / `*.env` files | Document only | Likely not needed in main |
| `data/*` (unique content) | `data-archive/worktree-backup/` | Backup if valuable test data |
| `backend/uploads/*` (unique) | `data-archive/worktree-uploads/` | Backup if valuable test docs |

**Package.json Fields to Transfer:**
- `main`: Should be `"electron/main.js"` if present in worktree
- `scripts.electron`: Electron launch script
- `scripts.dist*`: Build distribution scripts
- `build`: Complete electron-builder configuration object
- `devDependencies`: electron, electron-builder (if not in main)

**Expected Final Main Repo Structure:**
```
/Users/mbastakis/dev/personal/marvie-smeta/
├── electron/                    # If exists in worktree
│   ├── main.js
│   ├── preload.js
│   └── icons/
├── package.json                 # With electron config merged
├── rebuild-electron.sh          # Already exists
├── kill-and-launch.sh           # Already exists
├── build-all-platforms.sh       # Already exists
└── docs/
    └── ELECTRON_WORKTREE_TRANSFER_SUMMARY.md  # New
```

### Testing Standards

**Manual Testing Required:**
- Electron build and launch from main repo
- Web development mode (separate frontend/backend)
- All application features (upload, view, search, CAPA, KPIs)
- PDF viewer functionality
- Data persistence

**No Automated Tests for This Story:**
This is an infrastructure/maintenance task focused on repository cleanup. Testing is manual verification that functionality is preserved.

**Test Locations:**
- Test from main repository: `/Users/mbastakis/dev/personal/marvie-smeta`
- Verify absence of worktree: `/Users/mbastakis/dev/personal/marvie-smeta-electron` should not exist after cleanup

### Risk Assessment

**Primary Risk:** 
Accidentally losing uncommitted work or configurations in the worktree before transferring them.

**Mitigation:**
- Comprehensive audit phase before any deletions
- Document all findings before transfer
- Keep electron-app branch as backup even after worktree removal
- Create summary document of all transfers

**Rollback:**
If issues are discovered after cleanup:
1. Recreate worktree: `git worktree add ../marvie-smeta-electron electron-app`
2. Restore from branch history if needed
3. Re-transfer any missed content

**Low Risk Operation:**
- Git protects committed history
- Worktree removal only deletes working directory, not git history
- Branch preservation provides safety net
- All critical functionality already verified in main repo

## Definition of Done

- [ ] Audit complete with documented findings
- [ ] All valuable content transferred to main repository
- [ ] Transfer summary document created
- [ ] Electron worktree removed successfully
- [ ] Decision made on electron-app branch retention
- [ ] Documentation updated to reflect single-repo approach
- [ ] Electron functionality verified working from main repo
- [ ] Web development mode verified working
- [ ] Git repository state is clean
- [ ] No dangling worktree references

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-10-29 | 1.1 | Added package.json config handling, file transfer map, and clarified main repo state | Sarah (PO) |
| 2025-10-29 | 1.2 | Story approved and ready for implementation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
