# Story 2.5: CAPA Create/Edit Form Modal

## Status
**Ready for Review**

## Story
**As an** HR manager,  
**I want** a form to create and edit CAPA records,  
**so that** I can track corrective actions throughout the year.

## Acceptance Criteria
1. "Add CAPA" button opens modal dialog with form title "Create CAPA"
2. Edit button opens same modal with title "Edit CAPA" and form pre-populated with existing data
3. Form fields: CAPA ID (text, required, unique), Description (multiline text, required), Pillar (dropdown: Pillar 1-4), Severity (dropdown: Critical, Major, Minor, Observation)
4. Form fields: Status (dropdown: Open, In Progress, Closed, required, default: Open), Due Date (date picker), Root Cause (multiline text), Corrective Action (multiline text), Preventive Action (multiline text)
5. Form validation: Shows error messages under fields if required fields empty or CAPA ID duplicate
6. Save button disabled until required fields filled and valid
7. Save button calls POST (create) or PUT (edit) API endpoint with form data
8. Success: Snackbar "CAPA saved successfully", modal closes, list refreshes with new/updated CAPA selected
9. Error: Snackbar with API error message, modal remains open for retry
10. Cancel button closes modal without saving (shows confirmation if form has unsaved changes)

## Tasks / Subtasks
- [x] Create CAPAFormModal component
- [x] Implement all form fields with Material-UI
- [x] Add form validation
- [x] Implement create/update API calls
- [x] Add success/error handling
- [x] Add unsaved changes warning

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (2024-10-22)

### Implementation Summary
Successfully implemented CAPA create/edit form modal with comprehensive validation, error handling, and unsaved changes warning.

### Completion Notes
- Created CAPAFormModal component in components/capa/ directory
- Form dynamically switches between "Create CAPA" and "Edit CAPA" modes based on existingCapa prop
- All 9 form fields implemented with Material-UI components:
  - CAPA ID (TextField, required, unique validation)
  - Description (TextField multiline, required)
  - Pillar (Select dropdown with 4 pillar options + None)
  - Severity (Select dropdown: Critical, Major, Minor, Observation, None)
  - Status (Select dropdown: Open, In Progress, Closed, required, defaults to Open)
  - Due Date (TextField with type="date" picker)
  - Root Cause (TextField multiline)
  - Corrective Action (TextField multiline)
  - Preventive Action (TextField multiline)
- Form validation: Required fields checked, error messages displayed under fields
- Duplicate CAPA ID handling: Shows error under CAPA ID field when API returns 409 Conflict
- Save button disabled until required fields filled and valid
- Create mode: Calls POST /api/capas
- Edit mode: Calls PUT /api/capas/:id with existing CAPA pre-populated
- Success: Green snackbar "CAPA saved successfully", modal auto-closes after 500ms, calls onSuccess callback
- Error: Red snackbar with API error message, modal remains open for retry
- Unsaved changes tracking: Shows confirmation dialog if user tries to close with unsaved changes
- Cancel button closes modal (with confirmation if dirty)
- TypeScript type safety with proper CAPA interface usage

### File List
**New Files Created:**
- `frontend/src/components/capa/CAPAFormModal.tsx` - CAPA create/edit form modal component

**No Modified Files** - Form component is self-contained, will be integrated by CAPATracker (Story 2.4)

### Integration Notes for CAPATracker
To integrate this form into CAPATracker.tsx, replace the placeholder handlers:
```typescript
import { CAPAFormModal } from '../components/capa/CAPAFormModal';

// Add state
const [formModalOpen, setFormModalOpen] = useState(false);
const [editingCapa, setEditingCapa] = useState<CAPA | null>(null);

// Replace handlers
const handleAddCapa = () => {
  setEditingCapa(null);
  setFormModalOpen(true);
};

const handleEditCapa = () => {
  setEditingCapa(selectedCapa);
  setFormModalOpen(true);
};

const handleFormSuccess = (capa: CAPA) => {
  fetchCapas(); // Refresh list
  setSelectedCapa(capa); // Select new/updated CAPA
};

// Add component before closing Container
<CAPAFormModal
  open={formModalOpen}
  onClose={() => setFormModalOpen(false)}
  onSuccess={handleFormSuccess}
  existingCapa={editingCapa}
/>
```

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
| Timestamp | Change | Reason |
|-----------|--------|--------|
| 2025-10-28 19:52 | Implemented CAPAFormModal component | Created full create/edit form with validation |
| 2025-10-28 19:52 | Added unsaved changes warning | Prevents accidental data loss |
| 2025-10-28 19:52 | Fixed TypeScript type casting | Ensured type safety for optional enum fields |
