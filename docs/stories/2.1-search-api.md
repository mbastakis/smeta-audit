# Story 2.1: Document Search Backend API

## Status
**Ready for Review**

## Story
**As a** backend developer,  
**I want** a search API endpoint that queries documents by filename and metadata,  
**so that** the frontend can provide fast document search functionality.

## Acceptance Criteria
1. `GET /api/search?q={searchTerm}` endpoint accepts query parameter and returns matching documents
2. Search queries against: `original_filename`, `filename`, `pillar`, `category` fields using SQLite `LIKE` operator (case-insensitive)
3. Search returns documents array with all metadata fields plus relevance indicator (e.g., which field matched)
4. Empty search term returns 400 error with message "Search term required"
5. Search term minimum length 2 characters, returns 400 error if shorter
6. Results ordered by relevance: exact filename matches first, then partial matches, then pillar/category matches
7. Search returns maximum 50 results (pagination not required for MVP)
8. Search completes and returns results within 500ms for database with 200 documents
9. Endpoint handles special characters in search term (SQL injection prevention via parameterized queries)

## Tasks / Subtasks
- [x] Create search route handler
- [x] Implement case-insensitive LIKE query
- [x] Implement relevance ordering
- [x] Add validation (min length, empty check)
- [x] Add SQL injection prevention
- [x] Limit results to 50
- [x] Test performance with 200 documents

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Oct 28, 2025 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (2024-10-22)

### Implementation Summary
Successfully implemented document search API with case-insensitive LIKE queries, relevance ordering, validation, and SQL injection prevention.

### Completion Notes
- Created search route at GET /api/search?q={searchTerm}
- Implemented search() method in documentRepository with relevance scoring
- Relevance ordering: 1=exact filename match, 2=filename contains, 3=system filename contains, 4=pillar/category contains
- Case-insensitive search using SQLite LOWER() function
- Search queries against original_filename, filename, pillar, and category fields
- Validation: empty term returns 400, minimum 2 characters required
- Results limited to 50 maximum
- SQL injection prevention via parameterized queries (all user input properly escaped)
- Returns JSON with query, count, and results array
- Relevance score included in results for debugging/frontend use

### File List
**New Files Created:**
- `backend/src/routes/search.ts` - Search route handler

**Modified Files:**
- `backend/src/app.ts` - Registered search route
- `backend/src/repositories/documentRepository.ts` - Added search() method with relevance ordering

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
| Timestamp | Change | Reason |
|-----------|--------|--------|
| 2025-10-28 19:35 | Implemented search route and repository method | Created search API with relevance ordering |
| 2025-10-28 19:35 | Added validation and SQL injection prevention | Input validation and parameterized queries |
